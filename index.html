<script>
    let isLoaded = false;
    
    // 监听脚本是否真的加载到了全局变量
    function loaded() {
        console.log("LiFi 资源已物理就绪");
        isLoaded = true;
        const msg = document.getElementById('msg');
        if (msg) {
            msg.innerText = "[ 交付就绪 - 点击进入 ]";
            msg.style.color = "#000";
        }
    }

    // 备用检查：防止 onload 不触发
    setInterval(() => {
        if (!isLoaded && typeof LiFiWidget !== 'undefined') {
            loaded();
        }
    }, 1000);

    function activate() {
        if (!isLoaded || typeof LiFiWidget === 'undefined') {
            alert("协议尚未同步，请稍等或刷新");
            return;
        }

        // 1. 彻底移除封面，释放空间
        const splash = document.getElementById('splash');
        splash.remove(); 

        // 2. 动态创建容器（避免隐藏导致的渲染空白）
        const container = document.createElement('div');
        container.id = 'lifi-widget-active';
        container.style.width = '420px';
        container.style.height = '640px';
        container.style.margin = '0 auto';
        document.getElementById('app').appendChild(container);

        // 3. 执行 v1.3 样式渲染
        const config = {
            integrator: 'l2-navigator',
            appearance: 'light',
            containerStyle: {
                border: '1px solid #EEE',
                borderRadius: '16px'
            },
            theme: {
                palette: { primary: { main: '#000000' } }
            }
        };

        try {
            console.log("正在初始化面板...");
            // 直接将组件挂载到新创建的容器中
            LiFiWidget.renderWidget(container.id, config);
        } catch (e) {
            console.error("渲染异常:", e);
            container.innerHTML = `<p style="color:red">渲染冲突，请尝试刷新页面</p>`;
        }
    }
</script>
